# Use GitHub Actions to compile OpenWrt

The Documentation idea of this repository comes from [Actions-OpenWrt](https://github.com/P3TERX/Actions-OpenWrt) shared by P3TERX. The tutorial mainly relies on his Chinese instruction document, and some instructions applicable to `OpenWrt for Amlogic S9xxx series boxes` were added during the writing process. If you understand Chinese, you can check his Chinese documentation in his repository.

Based on the GitHub Actions compilation tutorial provided by `P3TERX`, based on the packaging script provided by `tuanqing`, based on the `OpenWrt for Amlogic S9xxx` kernel files and installation/upgrade scripts and other resources provided by `Flippy`, I integrated them together. Share with friends who use the `OpenWrt` system on `Amlogic S9xxx`, so that you have more choices when customizing your personalized software package. Due to my limited programming skills and limited language skills, if there are errors in the content, please correct me, and I would like to express my gratitude.

`GitHub Actions` is a service launched by `Microsoft`. It provides a virtual server environment with very good performance configuration. Based on it, projects can be built, tested, packaged, and deployed. The public repository can be used for free without time limit, and the single compilation time is up to `6 hours`, which is enough for `compiling OpenWrt` (we can usually complete a compilation in about `3 hours`). Sharing is only for the exchange of experience. Please understand the deficiencies. Please do not initiate various bad attacks on the Internet, and do not maliciously use it.

# Tutorial directory

- [1. Register your own GitHub account](#1-register-your-own-github-account)
- [2. Set the privacy variable GitHub_TOKEN](#2-set-the-privacy-variable-github_token)
- [3. Fork repository and set RELEASES_TOKEN](#3-fork-repository-and-set-releases_token)
- [4. Personalized OpenWrt firmware customization file description](#4-personalized-openwrt-firmware-customization-file-description)
- [4.1 .config file description](#41-config-file-description)
- [4.1.1 Let the firmware support the native language](#411-let-the-firmware-support-the-native-language)
- [4.1.2 Select the personalized software package](#412-select-the-personalized-software-package)
- [4.2 DIY script operation: diy-part1.sh and diy-part2.sh](#42-diy-script-operation-diy-part1sh-and-diy-part2sh)
- [Example 1, add a third-party software package](#example-1-add-a-third-party-software-package)
- [Example 2: Replace the existing software package](#example-2-replace-the-existing-software-package)
- [Example 3: Modifying the code in the source code library](#example-3-modifying-the-code-in-the-source-code-library)
- [5. Compile the firmware](#5-compile-the-firmware)
- [5.1 Manual compilation](#51-manual-compilation)
- [5.2 Compile at the agreed time](#52-compile-at-the-agreed-time)
- [6. Save the firmware](#6-save-the-firmware)
- [6.1 Save to GitHub Actions](#61-save-to-github-actions)
- [6.2 Save to GitHub Releases](#62-save-to-github-releases)
- [6.3 Save to a third party](#63-save-to-a-third-party-such-as-wetransfer)
- [7. Download the firmware](#7-download-the-firmware)
- [7.1 Download from GitHub Actions](#71-download-from-github-actions)
- [7.2 Download from GitHub Releases](#72-download-from-github-releases)
- [7.3 Download from third parties](#73-download-from-third-parties)
- [8. Install the firmware](#8-install-the-firmware)
- [9. Upgrade firmware](#9-upgrade-firmware)
- [10. Personalized firmware customization upgrade tutorial](#10-personalized-firmware-customization-upgrade-tutorial)
- [10.1 Know the complete .config file](#101-know-the-complete-config-file)
- [10.2 Know the workflow file](#102-know-the-workflow-file)
- [10.3 Use SSH to remotely connect to GitHub Actions](#103-use-ssh-to-remotely-connect-to-github-actions)
- [10.4 Custom feeds configuration file](#104-custom-feeds-configuration-file)
- [10.5 Custom software default configuration information](#105-custom-software-default-configuration-information)

## 1. Register your own GitHub account

Register your own account, so that you can continue to customize the firmware. Click the `Sign up` button in the upper right corner of the `giuhub.com` website and follow the prompts to `register your account`.

## 2. Set the privacy variable GitHub_TOKEN

Set the GitHub privacy variable `GitHub_TOKEN`. After the firmware is compiled, we need to upload the firmware to `GitHub Releases`. We set this variable according to the official requirements of GitHub. The method is as follows:
`Personal center`: `Settings` > `Developer settings` > `Personal access tokens` > `Generate new token` ( Name: `GitHub_TOKEN`, Select: `public_repo` ). `Other options` can be selected according to your needs. Submit and save, copy the `Encrypted KEY Value` generated by the system, and `save it` to your computer's notepad first. This value will be used in the next step. The icons are as follows:

<div style="width:100%;margin-top:40px;margin:5px;">
<img src=https://user-images.githubusercontent.com/68696949/109416409-0c976c80-79f9-11eb-8bab-4bfe5f439d6a.png width="150" style="border:5px solid red" />
<img src=https://user-images.githubusercontent.com/68696949/109416412-102af380-79f9-11eb-9be2-fb54f0d1ac5d.png width="300" />
<img src=https://user-images.githubusercontent.com/68696949/109416418-16b96b00-79f9-11eb-8aed-1936cc53cb3c.png width="500" />
<img src=https://user-images.githubusercontent.com/68696949/109416441-3b154780-79f9-11eb-88f6-73fa72c2c6d0.png width="500" />
<img src=https://user-images.githubusercontent.com/68696949/109416422-1b7e1f00-79f9-11eb-8fac-d86269cc01ef.png width="500" />
</div>

## 3. Fork repository and set RELEASES_TOKEN

Now you can `Fork` the `repository`, open the repository [https://github.com/ophub/amlogic-s9xxx-openwrt](https://github.com/ophub/amlogic-s9xxx-openwrt), click the `Fork` button on the `upper right`, Will copy a copy of the repository code to your account, `wait a few seconds`, and prompt the Fork to complete Later, go to your account to access `amlogic-s9xxx-openwrt` in `your repository`. In the upper right corner of `Settings` > `Secrets` > `New repostiory secret` (Name: `RELEASES_TOKEN`, Value: `Fill in the value of GitHub_TOKEN` just now), `save it`. The icons are as follows:

## 4. Personalized OpenWrt firmware customization file description

After the previous 3 steps of preparation, let's start personalized firmware customization now. Have some files in the `/router_config` directory. Except for the description files, the other three are files for customizing OpenWrt firmware. In this chapter, we only make the simplest instructions, so that you can experience the happiness of personalized customization with your hands. I put more complex customization operations in `Section 10`, which requires you to have a little foundation.

### 4.1 .config file description

The `.config` file is the core file for personalized customization of the OpenWrt software package. It contains all the configuration information. Each line of code in the file represents a personalized configuration option. Although there are many projects, management is very simple. Let's get started.

#### 4.1.1 Let the firmware support the native language

in `# National language packs, luci-i18n-base:` Take France as an example, if you enable French language support, just put

```yaml
# CONFIG_PACKAGE_luci-i18n-base-fr is not set
```

change into

```yaml
CONFIG_PACKAGE_luci-i18n-base-fr=y
```

All the personalized customization in the `.config` file can be done in this way. For items you don't need, fill in `#` at the beginning of the line, and change `=y` to `is not set` at the end of the line. For the items you need, remove the `#` at the beginning of the line and change `is not set` to `=y` at the end

#### 4.1.2 Select the personalized software package

in `#LuCI-app:` The practice of enabling and deleting the default software package is the same as above. This time we delete the `luci-app-zerotier` plug-in in the default software package, just put

```yaml
CONFIG_PACKAGE_luci-app-zerotier=y
```
change into

```yaml
# CONFIG_PACKAGE_luci-app-zerotier is not set
```

I think you already know how to personalize the configuration. Each line of the `.config` file represents a configuration item. You can use this method to enable or delete the default configuration in the firmware. The complete content of this file has several thousand lines, I provide This is only a simplified version. How to obtain a complete configuration file for more complex and personalized customization is introduced in `Section 10`.

### 4.2 DIY script operation: diy-part1.sh and diy-part2.sh

The scripts `diy-part1.sh` and `diy-part2.sh` are executed `before and after` the `update and installation` of `feeds` respectively. When we introduce the OpenWrt source code library for personalized firmware compilation, sometimes we want to rewrite part of the code in the source code library, or add Some third-party software packages, delete or replace some software packages in the source code library, such as `modifying the default IP, host name, theme, adding/deleting software packages`, etc., these `modification instructions` to the source code library can be written to these two Script. Let's take the `OpenWrt` source code library provided by `coolsnowwolf` as the compilation object, to give a few examples.

Our following operations are based on this source code library: [https://github.com/coolsnowwolf/lede](https://github.com/coolsnowwolf/lede)

#### Example 1, add a third-party software package

The first step is to add the following code to `diy-part2.sh`:

```yaml
git clone https://github.com/jerrykuku/luci-app-ttnode.git package/lean/luci-app-ttnode
```

The second step is to add the activation code of this third-party software package to the `.config` file

```yaml
CONFIG_PACKAGE_luci-app-ttnode=y
```

This completes the integration of third-party software packages and expands the software packages that are not in the current source code repository.

#### Example 2: Replace the existing software package

Replace the existing software package with the same name in the current source code library with a third-party software package. The first step is to add the following code to `diy-part2.sh`:

First delete the original software package in the source code library, and Introduce a third-party package of the same name.

```yaml
rm -rf package/lean/luci-theme-argon
git clone https://github.com/jerrykuku/luci-theme-argon.git package/lean/luci-theme-argon
```

The second step is to add third-party software packages to the `.config` file.

```yaml
CONFIG_PACKAGE_luci-theme-argon=y
```

This realizes the use of a third-party software package to replace the existing software package with the same name in the current source code library.

#### Example 3: Modifying the code in the source code library

To achieve certain requirements by modifying the code in the source code library. We have added `luci-app-cpufreq` support for `aarch64` so that it can be used in our firmware (some modifications need to be cautious, you must know what you are doing).

Source file address: [luci-app-cpufreq/Makefile](https://github.com/coolsnowwolf/lede/blob/master/package/lean/luci-app-cpufreq/Makefile)

```yaml
sed -i 's/LUCI_DEPENDS.*/LUCI_DEPENDS:=\@\(arm\|\|aarch64\)/g' package/lean/luci-app-cpufreq/Makefile
```

This realizes the modification of the source code.

Through `diy-part1.sh` and `diy-part2.sh` two scripts, we add operation commands to make more powerful functions.

## 5. Compile the firmware

The firmware compilation process is controlled in the [.github/workflows/build-openwrt.yml](https://github.com/ophub/amlogic-s9xxx-openwrt/blob/main/.github/workflows/build-openwrt.yml) file. There are other `yml files` in the `workflows` directory to achieve other different functions. There are many ways to compile firmware, you can set timed compilation, manual compilation, or set some specific events to trigger compilation. Let's start with simple operations.

### 5.1 Manual compilation

In the `navigation bar of your repository`, click the `Actions` button, and then click `Build OpenWrt` > `Run workflow` > `Run workflow` to start the compilation, wait about `3 hours`, and complete the compilation after all the processes are over. The icons are as follows:

### 5.2 Compile at the agreed time

In the [.github/workflows/build-openwrt.yml](https://github.com/ophub/amlogic-s9xxx-openwrt/blob/main/.github/workflows/build-openwrt.yml) file, use `cron` to set the timing compilation. The 5 different positions represent min (0 - 59) / hour (0 - 23) / day of month (1 - 31) / month (1 - 12) / day of week (0 - 6)(Sunday - Saturday). Set the time by modifying the values of different positions. The system uses `UTC standard time` by default, please convert it according to the time zone of your country.

```yaml
schedule:
  - cron: '0 17 * * *'
```

## 6. Save the firmware

The settings saved by the firmware are also controlled in the [.github/workflows/build-openwrt.yml](https://github.com/ophub/amlogic-s9xxx-openwrt/blob/main/.github/workflows/build-openwrt.yml) file. We will automatically upload the compiled firmware to the `Actions` and `Releases` officially provided by `GitHub` through scripts, or upload it to a `third party` (such as WeTransfer).

Now the longest storage period of `Actions in GitHub is 90 days`, `Releases is permanent`, and third parties such as WeTransfer are 7 days. First of all, we thank these service providers for their free support, but we also ask you to use it sparingly. We advocate the reasonable use of free services.

### 6.1 Save to GitHub Actions

```yaml
- name: Upload artifact to Actions
  uses: kittaakos/upload-artifact-as-is@master
  if: steps.build.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
  with:
    path: ${{ env.FILEPATH }}/
```

### 6.2 Save to GitHub Releases

```yaml
- name: Upload OpenWrt Firmware to Release
  uses: softprops/action-gh-release@v1
  if: steps.build.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    tag_name: openwrt_s9xxx_${{ env.FILE_DATE }}
    files: ${{ env.FILEPATH }}/*
    body: |
      This is OpenWrt firmware for S9xxx-Boxs
      * Firmware information
      Default IP: 192.168.1.1
      Default username: root
      Default password: password
      Default WIFI name: OpenWrt
      Default WIFI password: none
      Install command: s9xxx-install.sh
      Upgrade command: s9xxx-update.sh
```
### 6.3 Save to a third party (such as WeTransfer)

```yaml
- name: Upload OpenWrt Firmware to WeTransfer
  if: steps.build.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
  run: |
    curl -fsSL git.io/file-transfer | sh
    ./transfer wet -s -p 16 --no-progress ${{ env.FILEPATH }}/{openwrt_s9xxx_*,openwrt_n1_*} 2>&1 | tee wetransfer.log
    echo "WET_URL=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV
```

## 7. Download the firmware

Download our compiled openwrt firmware.

### 7.1 Download from GitHub Actions

Click the `Actions` button in the `repository navigation bar`. In the `All workflows` list, click the compiled firmware list. In the firmware list inside, select the firmware corresponding to the model of your `Amlogic S9xxx boxes`. The icons are as follows: 

### 7.2 Download from GitHub Releases

Enter from the GitHub `Releases` section at the bottom right corner of the `repository homepage`, and select the firmware corresponding to the model of your `Amlogic S9xxx boxes`. The icons are as follows:

### 7.3 Download from third parties

In the [.github/workflows/build-openwrt.yml](https://github.com/ophub/amlogic-s9xxx-openwrt/blob/main/.github/workflows/build-openwrt.yml) file, upload to the third party is closed by default. If you need, change `false` to `true`, and upload to the third party when the compilation is completed next time. The third-party URL can be seen `in the log` of the firmware compilation process, and can also be output to the compilation information.

```yaml
UPLOAD_COWTRANSFER: false
UPLOAD_WETRANSFER: false
```

The support for uploading to a third party comes from [Mikubill/transfer](https://github.com/Mikubill/transfer). If you need it, you can add more third-party support according to his instructions (control your creativity and don't waste too many free resources). The icons are as follows:

## 8. Install the firmware

After downloading the compiled firmware, `decompress it` to get the `OpenWrt.img` file (the file name varies according to the `Amlogic S9xxx boxes`), use a mirror writing tool such as `balenaEtcher` to write the `OpenWrt.img` file to the `USB hard disk`, and then insert the USB hard disk In the USB port of your `Amlogic S9xxx boxes`, plug in the power and turn on the computer. Wait about `1 minute` to complete the `OpenWrt system startup`. Connect the `Amlogic S9xxx boxes` to your computer directly with a network cable.

In the wired network settings of `your computer`, change the IPV4 `IP` to manual settings, fill in the IP `192.168.1.2`, fill in the subnet mask `255.255.255.0`, and leave the other blanks blank.

Enter `192.168.1.1` in the browser to access `OpenWrt`. The default user name is `root` and the default password is `password`. After logging in, under the `System` menu, select the `TTYD terminal`, enter `s9xxx-install.sh` directly, and `press Enter`. Automatic installation. During the process, let you choose the type of your `Amlogic S9xxx boxes`, fill in the serial number correctly, such as `13`, `enter and press Enter` to continue the installation. The firmware will be written into the `EMMC` of the `Amlogic S9xxx boxes`. After the prompt is complete, `unplug the USB hard drive`, `unplug the power supply`, and `reinsert the power supply`. OpenWrt will boot from the `EMMC` partition of the `Amlogic S9xxx boxes`. Wait `1 minute` to log in. The IP is still `192.168.1.1`, and the account password is still the `default`. (If you don’t like to write to the `EMMC` of the `Amlogic S9xxx boxes`, you can `always plug in the USB hard disk and use OpenWrt in the USB`. The EMMC system responds `faster` to the USB hard disk.)

More detailed operations can be viewed in the detailed installation instructions of the repository: [amlogic-s9xxx/install-program](https://github.com/ophub/amlogic-s9xxx-OpenWrt/tree/main/amlogic-s9xxx/install-program)

## 9. Upgrade firmware

`Log in to your OpenWrt system`, under the `System` menu, select the `File Transfer` function to `upload the OpenWrt.img.gz firmware`, and `wait a while`, and see the system prompts that the `upload is complete`, select the `System menu` > `TTYD terminal` , and enter the `s9xxx-update.sh` command to upgrade. (You can upgrade from a higher version such as 5.40 to a lower version such as 5.30, or from a lower version such as 5.91 to a higher version such as 5.96. The kernel version number does not affect the upgrade, and `you can freely upgrade/downgrade`.)

## 10. Personalized firmware customization upgrade tutorial

If you see this step in the tutorial, I believe you already know how to play happily. If you don’t continue to read what is said later, I believe you will not be at ease. But, but ah, if you continue to explore in depth, you will start an extraordinary journey of tossing. You will encounter a lot of problems. This requires you to be prepared for continuous exploration, and you must be good at using `search engines` to solve problems. The time can go to various `OpenWrt communities` to learn.

### 10.1 Know the complete .config file

Use the official source code library of `OpenWrt` or the source code library of other branches to perform a `localized compilation`. For example, select the source code library of [coolsnowwolf/lede](https://github.com/coolsnowwolf/lede), and install the `Ubuntu system` locally and deploy the environment according to its compilation instructions. And `complete a local compilation`. In the local compilation configuration interface, you can also see a lot of rich instructions, which will strengthen your understanding of the OpenWrt compilation process.

After you complete the `OpenWrt personalized configuration` locally, `save and exit` the configuration interface. You can find the `.config` file in the root directory of the local OpenWrt source code library. You can upload this file directly to `your repository on github.com`, Replace the `router_config/.config` file.

### 10.2 Know the workflow file

The official GitHub gave a detailed explanation. Regarding the use of `GitHub Actions`, you can start to get to know it from here: [Quickstart for GitHub Actions](https://docs.github.com/en/Actions/quickstart)

### 10.3 Use SSH to remotely connect to GitHub Actions

You have performed `localization compilation` in 10.1 and have a certain understanding of related interactive interfaces. This experience is very useful. In the future, you can implement the same operations as localization in the cloud compilation of `GitHub Actions`.

When `manually starting the GitHub Actions` firmware compilation, change the value of `SSH connection to Actions` from the default `false` to `true`, and then wait about `10 minutes` in the `workflow`. When the compilation process completes the previous steps and arrives at the step of `SSH connection to Actions`, You can see the green `SSH remote connection command` and `browser access URL` from the `running log`. It is recommended to copy the green `SSH remote connection command`, `paste` the command in the SSH running terminal and press `Enter`, press the `q` key to enter the control panel according to the prompt, and enter `cd OpenWrt && make menuconfig` command to enter the OpenWrt personalized configuration options panel, `save` and exit after completing various operations, press `ctrl + d` to `exit` the SSH remote connection process, and let GitHub Actions continue to compile.

During SSH operation, copy the green SSH remote connection command in `ssh...io`. Apple MAC computers can directly use the `terminal` that comes with the system. If you have `OpenWrt` running, you can use the `TTYD terminal` under its system menu. If your computer has software such as `SecureCRT` or `PuTTY` installed, you can use any software that supports the SSH protocol.

If you don't have any SSH terminal, you can copy the `https://tma...` URL under the green URL, open it in a `browser`, and enter the same command as in the terminal according to the prompt. The browser's response speed may be slower than SSH, so be patient. The icons are as follows:

### 10.4 Custom feeds configuration file

When you look at the `feeds.conf.default` file in the `source code repository`, do you find that there are a lot of package libraries introduced here? You understand that right, we can find the source code library officially provided by OpenWrt on GitHub, as well as the branches of OpenWrt shared by many people. If you know them, you can add them from here. For example, [feeds.conf.default](https://github.com/coolsnowwolf/lede/blob/master/feeds.conf.default) in the `coolsnowwolf` source code library.

### 10.5 Custom software default configuration information

When we use `OpenWrt`, we have already configured many software. Most of the `configuration information` of these software is stored in your OpenWrt's `/etc/config/` and other related directories. Copy the storage files of these configuration information to In the `files` folder under the root directory of the `repository in GitHub`, please `keep the directory structure and files the same`. During OpenWrt compilation, the storage files of these configuration information will be compiled into your firmware. The specific method is in the [.github/workflows/build-openwrt.yml](https://github.com/ophub/amlogic-s9xxx-openwrt/blob/main/.github/workflows/build-openwrt.yml) file. Let's take a look at this code together:

```yaml
- name: Load custom configuration
  run: |
    [ -e files ] && mv files openwrt/files
    [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
    chmod +x $DIY_P2_SH
    cd openwrt
    $GITHUB_WORKSPACE/$DIY_P2_SH
```

Please do not copy the configuration information files that `involve privacy`. If `your repository is public`, then the files you put in the `files` directory are also `public`. Do not disclose the secrets. Some passwords and other information can be used using the `private key settings` you just learned in [Quickstart for GitHub Actions](https://docs.github.com/en/Actions/quickstart). You must understand what you are doing.

